#!/usr/bin/env groovy

pipeline {
  agent {
    dockerfile {
      additionalBuildArgs '--force-rm'
    }
  }

  environment {
    GIT_EMAIL = 'continuous.integration@intellihr.com.au'
    GIT_USER = 'IntelliHR CI'
  }

  stages {
    stage('Checkout gh-pages') {
      steps {
        dir ('/tmp/code/$BUILD_TAG') {
          sshagent (credentials: ['GITHUB_CI_SSH_KEY']) {
            sh '''
              git fetch --no-tags --progress git@github.com:intellihr/ui-components.git \
                +refs/heads/gh-pages:refs/remotes/origin/gh-pages
            '''
          }
        }
      }
    }

    stage('Build') {
      steps {
        dir ('/tmp/code/$BUILD_TAG') {
          sh 'yarn build'
        }
      }
    }

    stage('Publish gh-pages') {
      when {
        branch 'master'
      }

      steps {
        dir ('/tmp/code/$BUILD_TAG') {
          sshagent (credentials: ['GITHUB_CI_SSH_KEY']) {
            script {
              try {
                sh 'git add .'
                sh 'git -c user.email="$GIT_EMAIL" -c user.name="$GIT_USER" commit -m "Update gh-pages as of $(git log \'--format=format:%H\' remotes/origin/master -1)"'
                sh 'yarn gh-pages'
              } catch (Exception e) {
                echo 'No need to publish gh-pages...Skipping...'
              }
            }
          }
        }
      }
    }

    stage('Publish NPM') {
      when {
        branch 'master'
      }

      steps {
        dir ('/tmp/code/$BUILD_TAG') {
          sshagent (credentials: ['GITHUB_CI_SSH_KEY']) {
            sh 'git config user.email "$GIT_EMAIL"'
            sh 'git config user.name "$GIT_USER"'
          }

          withNPM(npmrcConfig: 'npm-config') {
            script {
              try {
                echo 'About to publish to npm'
                sh 'npm version patch'
              } catch (Exception e) {
                echo 'No need to update the version...Skipping...'
              }
            }
          }

          sshagent (credentials: ['GITHUB_CI_SSH_KEY']) {
            script {
              try {
                sh 'git branch'
                sh 'git push origin master'
              } catch (Exception e) {
                echo 'Nothing to push...'
              }
            }
          }
        }
      }
    }
  }
  post {
    always {
      dir ('/tmp/code/$BUILD_TAG') {
        deleteDir()
      }
    }
  }
}
